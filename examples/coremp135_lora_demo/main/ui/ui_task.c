// This file was generated by SquareLine Studio
// SquareLine Studio version: SquareLine Studio 1.4.0
// LVGL version: 8.3.11
// Project name: CoreLora
#include "ui_task.h"

#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

// #include "hv/base64.h"
// #include "hv/hv.h"
#include "hv/mqtt_client.h"

mqtt_client_t *mqtt_cli  = NULL;
static int uplink_cout   = 0;
static int DownLink_cout = 0;

static char *get_times() {
    static char time_buff[9];
    time_t now           = time(NULL);
    struct tm *tm_struct = localtime(&now);
    strftime(time_buff, 9, "%H:%M:%S", tm_struct);
    return time_buff;
}

static void anim_y_cb(void *obj, int32_t v) { lv_obj_set_y(obj, v); }
void animate_move_y(lv_obj_t *obj, int32_t start_y, int32_t end_y, uint32_t duration) {
    lv_anim_t a;
    lv_anim_init(&a);
    lv_anim_set_var(&a, obj);
    lv_anim_set_values(&a, start_y, end_y);
    lv_anim_set_time(&a, duration);
    lv_anim_set_exec_cb(&a, anim_y_cb);
    lv_anim_start(&a);
}

extern int get_IP_address(char *strbuf);
extern int mqtt_Parse(char *topic, int topic_len, char *payload, int payload_len, char **fport, char **DevEUI,
                      char **Freq, char **BW, char **SF, char **Rssi, char **Msg);

void get_system_info_cb(lv_timer_t *tmr) {
    char strbuff[256];
    // cpu
    static unsigned long long lastcpu[2] = {0};
    unsigned long long cpu[10];
    double loadavg;
    FILE *fsys;
    fsys = fopen("/proc/stat", "r");
    fscanf(fsys, "cpu %llu %llu %llu %llu %llu %llu %llu %llu %llu %llu", &cpu[0], &cpu[1], &cpu[2], &cpu[3], &cpu[4],
           &cpu[5], &cpu[6], &cpu[7], &cpu[8], &cpu[9]);
    fclose(fsys);
    unsigned long long all_cpu =
        cpu[0] + cpu[1] + cpu[2] + cpu[3] + cpu[4] + cpu[5] + cpu[6] + cpu[7] + cpu[8] + cpu[9] - lastcpu[0];
    unsigned long long idle_cpu = cpu[3] + cpu[4] - lastcpu[1];
    loadavg                     = (double)(all_cpu - idle_cpu) / all_cpu * 100.0;

    sprintf(strbuff, "%d%%", (int)loadavg);
    lv_label_set_text(ui_Label1, strbuff);

    lastcpu[0] = all_cpu;
    lastcpu[1] = idle_cpu;

    // mem
    unsigned long total_memory, free_memory;
    fsys = fopen("/proc/meminfo", "r");
    while (fgets(strbuff, sizeof(strbuff), fsys)) {
        if (strncmp(strbuff, "MemTotal:", 9) == 0) {
            sscanf(strbuff, "MemTotal: %lu kB", &total_memory);
            continue;
        }
        if (strncmp(strbuff, "MemAvailable:", 13) == 0) {
            sscanf(strbuff, "MemAvailable: %lu kB", &free_memory);
            break;
        }
    }
    fclose(fsys);
    sprintf(strbuff, "%d/%d MB", total_memory / 1024, (total_memory - free_memory) / 1024);
    lv_label_set_text(ui_Label4, strbuff);

    // temp
    unsigned long temper;
    fsys = fopen("/sys/class/thermal/thermal_zone0/temp", "r");
    fscanf(fsys, "%lu", &temper);
    fclose(fsys);
    sprintf(strbuff, "%dC", temper / 1000);
    lv_label_set_text(ui_Label3, strbuff);

    // ip
    get_IP_address(strbuff);
    lv_label_set_text(ui_Label5, strbuff);
}

extern pthread_mutex_t ui_thread_mutex;
lv_obj_t *positiono[3][5];
lv_obj_t *positionoA[3];
lv_obj_t *positionoB[3];
int next_display_count() {
    static int flage            = 0;
    static int position_cout[3] = {0, 1, 2};
    if (flage > 2) {
        animate_move_y(positionoA[position_cout[0]], 239, 196, 500);
        animate_move_y(positionoA[position_cout[1]], 148, 101, 500);
        animate_move_y(positionoA[position_cout[2]], 196, 148, 500);
        int temp         = position_cout[0];
        position_cout[0] = position_cout[1];
        position_cout[1] = position_cout[2];
        position_cout[2] = temp;
        return temp;
    } else {
        positiono[0][0] = ui_Label12;
        positiono[0][1] = ui_Label10;
        positiono[0][2] = ui_Label9;
        positiono[0][3] = ui_Label8;
        positiono[0][4] = ui_Label11;
        positiono[1][0] = ui_Label15;
        positiono[1][1] = ui_Label13;
        positiono[1][2] = ui_Label2;
        positiono[1][3] = ui_Label17;
        positiono[1][4] = ui_Label14;
        positiono[2][0] = ui_Label22;
        positiono[2][1] = ui_Label20;
        positiono[2][2] = ui_Label19;
        positiono[2][3] = ui_Label18;
        positiono[2][4] = ui_Label21;
        positionoA[0]   = ui_Container2;
        positionoA[1]   = ui_Container3;
        positionoA[2]   = ui_Container4;
        positionoB[0]   = ui_Image14;
        positionoB[1]   = ui_Image15;
        positionoB[2]   = ui_Image16;
        return flage++;
    }
}

void flush_lora_msg_to_display(char *topic, int topic_len, char *payload, int payload_len) {
    static int active = 1;
    int msg_type      = 0;
    char strbuff[256];
    char *fport  = NULL;
    char *DevEUI = NULL;
    char *Freq   = NULL;
    char *BW     = NULL;
    char *SF     = NULL;
    char *Rssi   = NULL;
    char *Msg    = NULL;
    mqtt_Parse(topic, topic_len, payload, payload_len, &fport, &DevEUI, &Freq, &BW, &SF, &Rssi, &Msg);
    uplink_cout++;
    pthread_mutex_lock(&ui_thread_mutex);
    int index = next_display_count();
    sprintf(strbuff, "%s", fport);
    lv_label_set_text(positiono[index][0], fport);
    sprintf(strbuff, "%s DevEUI:%s", get_times(), DevEUI);
    lv_label_set_text(positiono[index][1], strbuff);
    sprintf(strbuff, "Freq:%s BW:%s SF:%s Rssi:%s", Freq, BW, SF, Rssi);
    lv_label_set_text(positiono[index][2], strbuff);
    sprintf(strbuff, "Msg: %s", Msg);
    lv_label_set_text(positiono[index][3], strbuff);
    lv_label_set_text(positiono[index][4], "up");
    lv_img_set_src(positionoB[index], &ui_img_rectangle_16_png);
    lv_obj_clear_flag(positionoA[index], LV_OBJ_FLAG_HIDDEN);
    sprintf(strbuff, "%d", uplink_cout);
    lv_label_set_text(ui_Label6, strbuff);
    pthread_mutex_unlock(&ui_thread_mutex);
}

static void on_mqtt(mqtt_client_t *cli, int type) {
    switch (type) {
        case MQTT_TYPE_CONNACK: {
            mqtt_client_subscribe(cli, "application/+/device/+/event/up", 0);
        } break;
        case MQTT_TYPE_PUBLISH: {
            mqtt_message_t *msg = &cli->message;
            // printf("topic: %.*s\n", msg->topic_len, msg->topic);
            // printf("payload: %.*s\n", msg->payload_len, msg->payload);
            flush_lora_msg_to_display((char *)msg->topic, msg->topic_len, (char *)msg->payload, msg->payload_len);
        } break;
        default:
            break;
    }
}
pthread_t mqtt_loop_pthread_id;
static void *mqtt_loop(void *arg) {
    mqtt_cli            = mqtt_client_new(NULL);
    mqtt_cli->keepalive = 10;
    mqtt_client_set_auth(mqtt_cli, "chirp", "chirp");
    mqtt_client_set_callback(mqtt_cli, on_mqtt);

    reconn_setting_t reconn;
    reconn_setting_init(&reconn);
    reconn.min_delay    = 1000;
    reconn.max_delay    = 10000;
    reconn.delay_policy = 2;
    mqtt_client_set_reconnect(mqtt_cli, &reconn);

    mqtt_client_connect(mqtt_cli, "127.0.0.1", 1883, 0);
    mqtt_client_run(mqtt_cli);
    mqtt_client_free(mqtt_cli);
    mqtt_cli = NULL;
    return NULL;
}

void connect_mqtt() { pthread_create(&mqtt_loop_pthread_id, NULL, mqtt_loop, NULL); }

void lora_enquene_msg_cb(lv_timer_t *tmr) {
    static int old_uplink_cout;
    char topic[128];
    char payload[128];

    if ((mqtt_cli != NULL) && mqtt_client_is_connected(mqtt_cli)) {
        mqtt_message_t msg;
        msg.topic   = topic;
        msg.payload = payload;
        msg.qos     = 0;
        msg.retain  = 0;
        msg.topic_len =
            sprintf(topic, "application/94d9ff1f-6e2e-4e70-bdf0-2cadbdbb4ef0/device/4bee530d29435bef/command/down");
        msg.payload_len = sprintf(
            payload, "{\"dev_eui\": \"4bee530d29435bef\",\"confirmed\": false,\"fPort\": 10,\"data\": \"qrvM\"}");
        if (old_uplink_cout != uplink_cout) {
            mqtt_client_publish(mqtt_cli, &msg);
            old_uplink_cout = uplink_cout;
        }

        DownLink_cout++;
        int index = next_display_count();
        sprintf(payload, "%d", 10);
        lv_label_set_text(positiono[index][0], payload);
        sprintf(payload, "%s DevEUI:%s", get_times(), "4bee530d29435bef");
        lv_label_set_text(positiono[index][1], payload);
        sprintf(payload, "Freq:%s BW:%s SF:%s Rssi:%s", "868.0M", "125K", "7", "-60");
        lv_label_set_text(positiono[index][2], payload);
        sprintf(payload, "Msg: %s", "01 02");
        lv_label_set_text(positiono[index][3], payload);
        lv_label_set_text(positiono[index][4], "down");
        lv_img_set_src(positionoB[index], &ui_img_rectangle_15_png);
        lv_obj_clear_flag(positionoA[index], LV_OBJ_FLAG_HIDDEN);
        sprintf(payload, "%d", DownLink_cout);
        lv_label_set_text(ui_Label7, payload);
    }
}